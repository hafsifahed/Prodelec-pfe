<div class="container py-4">
  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status"></div>
    <div>Chargement du projet...</div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger my-4">
    {{ errorMessage }}
  </div>

  <div *ngIf="project" class="card shadow-lg">
    <div class="card-header bg-primary text-white">
      <h2 class="mb-0">Détail du projet : {{ project.refProdelec }}</h2>
    </div>
    <div class="card-body">
      <ul class="list-group list-group-flush mb-4">
        <li class="list-group-item"><strong>Client :</strong> {{ project.order?.user?.username }}</li>
        <li class="list-group-item"><strong>Date Réception BC :</strong> {{ project.order?.createdAt | date:'yyyy-MM-dd' }}</li>
        <li class="list-group-item"><strong>N° BC :</strong> {{ project.order?.orderName }}</li>
        <li class="list-group-item"><strong>Réf. Client :</strong> {{ project.refClient }}</li>
        <li class="list-group-item"><strong>Quantité :</strong> {{ project.qte }}</li>
        <li class="list-group-item"><strong>Date de livraison prévue :</strong> 
          <span [ngClass]="{'text-danger': isDateOverdue(project.dlp,project)}">
            {{project.dlp | date:'yyyy-MM-dd'}}
          </span>
        </li>
        <li class="list-group-item"><strong>Durée :</strong> {{project.duree}} heures</li>
        <li class="list-group-item"><strong>Date de création :</strong> {{project.createdAt | date:'yyyy-MM-dd HH:mm'}}</li>
        <li class="list-group-item"><strong>Date de mise à jour :</strong> {{project.updatedAt | date:'yyyy-MM-dd HH:mm'}}</li>
      </ul>

      <!-- Progressions -->
      <div class="row gy-3 mb-4">
        <!-- Conception -->
        <div class="col-md-6">
          <div class="mb-2 d-flex align-items-center justify-content-between">
            <span>
              <span class="badge" [ngClass]="project.conceptionStatus ? 'bg-success' : 'bg-danger'">
                {{ project.conceptionStatus ? 'Conception : Terminé' : 'Conception : En cours' }}
              </span>
              <span *ngIf="isDateOverdue1(project.endConception, project.realendConception)" class="badge bg-warning ms-2">En retard</span>
            </span>
            <span>{{ project.conceptionprogress }}%</span>
          </div>
          <div class="progress mb-1" style="height: 20px;">
            <div class="progress-bar bg-info" role="progressbar" [style.width]="project.conceptionprogress + '%'"
              [attr.aria-valuenow]="project.conceptionprogress" aria-valuemin="0" aria-valuemax="100">
              {{ project.conceptionprogress }}%
            </div>
          </div>
          <!-- *ngIf="(userr && project.conceptionResponsible && project.conceptionResponsible.id == userr.id) || userr.role?.name === 'SUBADMIN'" -->
          <input 
            type="range" min="0" max="100" [value]="project.conceptionprogress"
            (input)="updateConceptionProgress(project, $event)" class="form-range" />
        </div>
        <!-- Méthode -->
        <div class="col-md-6">
          <div class="mb-2 d-flex align-items-center justify-content-between">
            <span>
              <span class="badge" [ngClass]="project.methodeStatus ? 'bg-success' : 'bg-danger'">
                {{ project.methodeStatus ? 'Méthode : Terminé' : 'Méthode : En cours' }}
              </span>
              <span *ngIf="isDateOverdue1(project.endMethode, project.realendMethode)" class="badge bg-warning ms-2">En retard</span>
            </span>
            <span>{{ project.methodeprogress }}%</span>
          </div>
          <div class="progress mb-1" style="height: 20px;">
            <div class="progress-bar bg-info" role="progressbar" [style.width]="project.methodeprogress + '%'"
              [attr.aria-valuenow]="project.methodeprogress" aria-valuemin="0" aria-valuemax="100">
              {{ project.methodeprogress }}%
            </div>
          </div>
          <!-- *ngIf="(userr && project.methodeResponsible && userr.id == project.methodeResponsible.id) || userr.role?.name === 'SUBADMIN'" -->
          <input 
            type="range" min="0" max="100" [value]="project.methodeprogress"
            (input)="updatemProgress(project, $event)" class="form-range" />
        </div>
        <!-- Production -->
        <div class="col-md-6">
          <div class="mb-2 d-flex align-items-center justify-content-between">
            <span>
              <span class="badge" [ngClass]="project.productionStatus ? 'bg-success' : 'bg-danger'">
                {{ project.productionStatus ? 'Production : Terminé' : 'Production : En cours' }}
              </span>
              <span *ngIf="isDateOverdue1(project.endProduction, project.realendProduction)" class="badge bg-warning ms-2">En retard</span>
            </span>
            <span>{{ project.productionprogress }}%</span>
          </div>
          <div class="progress mb-1" style="height: 20px;">
            <div class="progress-bar bg-info" role="progressbar" [style.width]="project.productionprogress + '%'"
              [attr.aria-valuenow]="project.productionprogress" aria-valuemin="0" aria-valuemax="100">
              {{ project.productionprogress }}%
            </div>
          </div>
          <!-- *ngIf="(userr && project.productionResponsible && userr.id == project.productionResponsible.id) || userr.role?.name === 'SUBADMIN'" -->
          <input 
            type="range" min="0" max="100" [value]="project.productionprogress"
            (input)="updatepProgress(project, $event)" class="form-range" />
        </div>
        <!-- Contrôle final -->
        <div class="col-md-6">
          <div class="mb-2 d-flex align-items-center justify-content-between">
            <span>
              <span class="badge" [ngClass]="project.finalControlStatus ? 'bg-success' : 'bg-danger'">
                {{ project.finalControlStatus ? 'Contrôle final : Terminé' : 'Contrôle final : En cours' }}
              </span>
              <span *ngIf="isDateOverdue1(project.endFc, project.realendFc)" class="badge bg-warning ms-2">En retard</span>
            </span>
            <span>{{ project.fcprogress }}%</span>
          </div>
          <div class="progress mb-1" style="height: 20px;">
            <div class="progress-bar bg-info" role="progressbar" [style.width]="project.fcprogress + '%'"
              [attr.aria-valuenow]="project.fcprogress" aria-valuemin="0" aria-valuemax="100">
              {{ project.fcprogress }}%
            </div>
          </div>
          <!-- *ngIf="(userr && project.finalControlResponsible && userr.id == project.finalControlResponsible.id) || userr.role?.name === 'SUBADMIN'" -->
          <input 
            type="range" min="0" max="100" [value]="project.fcprogress"
            (input)="updatefcProgress(project, $event)" class="form-range" />
        </div>
        <!-- Livraison -->
        <div class="col-md-6">
          <div class="mb-2 d-flex align-items-center justify-content-between">
            <span>
              <span class="badge" [ngClass]="project.deliveryStatus ? 'bg-success' : 'bg-danger'">
                {{ project.deliveryStatus ? 'Livraison : Terminé' : 'Livraison : En cours' }}
              </span>
              <span *ngIf="isDateOverdue1(project.endDelivery, project.realendDelivery)" class="badge bg-warning ms-2">En retard</span>
            </span>
            <span>{{ project.deliveryprogress }}%</span>
          </div>
          <div class="progress mb-1" style="height: 20px;">
            <div class="progress-bar bg-info" role="progressbar" [style.width]="project.deliveryprogress + '%'"
              [attr.aria-valuenow]="project.deliveryprogress" aria-valuemin="0" aria-valuemax="100">
              {{ project.deliveryprogress }}%
            </div>
          </div>
          <!-- *ngIf="(userr && project.deliveryResponsible && userr.id == project.deliveryResponsible.id) || userr.role?.name === 'SUBADMIN'" -->
          <input 
            type="range" min="0" max="100" [value]="project.deliveryprogress"
            (input)="updatedProgress(project, $event)" class="form-range" />
        </div>
        <!-- Progression totale -->
        <div class="col-md-6">
          <div class="mb-2 d-flex align-items-center justify-content-between">
            <span class="fw-bold">Progression totale</span>
            <span>{{ project.progress }}%</span>
          </div>
          <div class="progress" style="height: 20px;">
            <div class="progress-bar bg-primary" role="progressbar" [style.width]="project.progress + '%'"
              [attr.aria-valuenow]="project.progress" aria-valuemin="0" aria-valuemax="100">
              {{ project.progress }}%
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="d-flex flex-wrap gap-2 mt-4">
        <button class="btn btn-primary" (click)="editModal(project.idproject)">
          <i class="mdi mdi-pencil"></i> Modifier
        </button>
        <button class="btn btn-danger" (click)="delete(project.idproject)">
          <i class="mdi mdi-delete"></i> Supprimer
        </button>
        <button class="btn btn-warning" (click)="archive(project.idproject)">
          <i class="mdi mdi-archive"></i> Archiver
        </button>
        <button class="btn btn-success" (click)="addModal(project)">
          <i class="mdi mdi-plus"></i> Dupliquer
        </button>
      </div>
    </div>
  </div>
</div>
