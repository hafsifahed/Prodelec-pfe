<div class="modal-header">
  <h5 class="modal-title">Modifier projet</h5>
  <button type="button" class="btn-close" (click)="closeModal()"></button>
</div>
<div class="modal-body">
  <form (ngSubmit)="updateproject()" [formGroup]="projectForm" novalidate>

    <!-- Boutons d'affichage des sections - Conditionnés par les cases à cocher -->
    <div class="mb-3 d-flex flex-wrap gap-2">
      <button *ngIf="projectForm.get('conceptionChecked').value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('conception')">
        {{ showSections.conception ? 'Masquer Conception' : 'Afficher Conception' }}
      </button>
      <button *ngIf="projectForm.get('methodeChecked').value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('methode')">
        {{ showSections.methode ? 'Masquer Méthode' : 'Afficher Méthode' }}
      </button>
      <button *ngIf="projectForm.get('productionChecked').value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('production')">
        {{ showSections.production ? 'Masquer Production' : 'Afficher Production' }}
      </button>
      <button *ngIf="projectForm.get('controleChecked').value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('controle')">
        {{ showSections.controle ? 'Masquer Contrôle finale' : 'Afficher Contrôle finale' }}
      </button>
      <button *ngIf="projectForm.get('livraisonChecked').value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('livraison')">
        {{ showSections.livraison ? 'Masquer Livraison' : 'Afficher Livraison' }}
      </button>
    </div>

    <!-- Cases à cocher pour existence des phases -->
    <div class="mb-4" *ngIf="user.role.name === 'Responsable Industrialisation'">
      <label class="form-label fw-semibold">Phases existantes</label>
      <div class="form-check">
        <input type="checkbox" id="conceptionChecked" class="form-check-input" formControlName="conceptionChecked" />
        <label class="form-check-label" for="conceptionChecked">Conception</label>
      </div>
      <div class="form-check">
        <input type="checkbox" id="methodeChecked" class="form-check-input" formControlName="methodeChecked" />
        <label class="form-check-label" for="methodeChecked">Méthode</label>
      </div>
      <div class="form-check">
        <input type="checkbox" id="productionChecked" class="form-check-input" formControlName="productionChecked" />
        <label class="form-check-label" for="productionChecked">Production</label>
      </div>
      <div class="form-check">
        <input type="checkbox" id="controleChecked" class="form-check-input" formControlName="controleChecked" />
        <label class="form-check-label" for="controleChecked">Contrôle final</label>
      </div>
      <div class="form-check">
        <input type="checkbox" id="livraisonChecked" class="form-check-input" formControlName="livraisonChecked" />
        <label class="form-check-label" for="livraisonChecked">Livraison</label>
      </div>
    </div>

    <div class="row g-4">
      <!-- Informations générales -->
      <div class="col-12">
        <div class="row g-3">
          <div class="col-lg-3 col-md-6">
            <label class="form-label">Ref Client</label>
            <input type="text" class="form-control" formControlName="refc" required />
          </div>
          <div class="col-lg-3 col-md-6">
            <label class="form-label">Ref Prodelec</label>
            <input type="text" class="form-control" formControlName="refp" required />
          </div>
          <div class="col-lg-3 col-md-6">
            <label class="form-label">Quantité</label>
            <input type="number" class="form-control" formControlName="qte" required />
          </div>
          <div class="col-lg-3 col-md-6">
            <label class="form-label">Date de livraison prévue</label>
            <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="dlp" />
          </div>
        </div>
      </div>

      <!-- Section Conception - Conditionnée par case cochée ET showSections -->
      <div class="col-12" *ngIf="showSections.conception && projectForm.get('conceptionChecked').value">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white fw-semibold">
            Conception
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Durée</label>
                <input type="number" class="form-control" formControlName="drc" />
              </div>
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Pilote</label>
                <select class="form-select" formControlName="rc">
                  <option value="">Sélectionner</option>
                  <option *ngFor="let dt of listr" [value]="dt.username">{{ dt.username }}</option>
                </select>
              </div>
              <div class="col-lg-4 col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea class="form-control" formControlName="cdc" rows="1"></textarea>
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Début</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="dc" />
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Fin</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="fc" />
              </div>
              <!-- Bouton de sélection de plage conditionné par la case à cocher -->
              <div class="col-12" *ngIf="projectForm.get('conceptionChecked').value">
                <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('conception')">
                  <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Méthode - Conditionnée par case cochée ET showSections -->
      <div class="col-12" *ngIf="showSections.methode && projectForm.get('methodeChecked').value">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white fw-semibold">
            Méthode
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Durée</label>
                <input type="number" class="form-control" formControlName="drm" />
              </div>
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Pilote</label>
                <select class="form-select" formControlName="rm">
                  <option value="">Sélectionner</option>
                  <option *ngFor="let dt of listr" [value]="dt.username">{{ dt.username }}</option>
                </select>
              </div>
              <div class="col-lg-4 col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea class="form-control" formControlName="cdm" rows="1"></textarea>
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Début</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="dm" />
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Fin</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="fm" />
              </div>
              <!-- Bouton de sélection de plage conditionné par la case à cocher -->
              <div class="col-12" *ngIf="projectForm.get('methodeChecked').value">
                <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('methode')">
                  <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Production - Conditionnée par case cochée ET showSections -->
      <div class="col-12" *ngIf="showSections.production && projectForm.get('productionChecked').value">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white fw-semibold">
            Production
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Durée</label>
                <input type="number" class="form-control" formControlName="drp" />
              </div>
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Pilote</label>
                <select class="form-select" formControlName="rp">
                  <option value="">Sélectionner</option>
                  <option *ngFor="let dt of listr" [value]="dt.username">{{ dt.username }}</option>
                </select>
              </div>
              <div class="col-lg-4 col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea class="form-control" formControlName="cdp" rows="1"></textarea>
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Début</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="dp" />
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Fin</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="fp" />
              </div>
              <!-- Bouton de sélection de plage conditionné par la case à cocher -->
              <div class="col-12" *ngIf="projectForm.get('productionChecked').value">
                <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('production')">
                  <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Contrôle finale - Conditionnée par case cochée ET showSections -->
      <div class="col-12" *ngIf="showSections.controle && projectForm.get('controleChecked').value">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white fw-semibold">
            Contrôle finale
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Durée</label>
                <input type="number" class="form-control" formControlName="drcf" />
              </div>
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Pilote</label>
                <select class="form-select" formControlName="rcf">
                  <option value="">Sélectionner</option>
                  <option *ngFor="let dt of listr" [value]="dt.username">{{ dt.username }}</option>
                </select>
              </div>
              <div class="col-lg-4 col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea class="form-control" formControlName="cdcf" rows="1"></textarea>
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Début</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="dcf" />
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Fin</label>
                <input bsDatepicker class="form-control" placeholder="dd-MM-yyyy" formControlName="fcf" />
              </div>
              <!-- Bouton de sélection de plage conditionné par la case à cocher -->
              <div class="col-12" *ngIf="projectForm.get('controleChecked').value">
                <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('controle')">
                  <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Livraison - Conditionnée par case cochée ET showSections -->
      <div class="col-12" *ngIf="showSections.livraison && projectForm.get('livraisonChecked').value">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white fw-semibold">
            Livraison
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Durée</label>
                <input type="number" class="form-control" formControlName="drl" />
              </div>
              <div class="col-lg-4 col-md-6">
                <label class="form-label">Pilote</label>
                <select class="form-select" formControlName="rl">
                  <option value="">Sélectionner</option>
                  <option *ngFor="let dt of listr" [value]="dt.username">{{ dt.username }}</option>
                </select>
              </div>
              <div class="col-lg-4 col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea class="form-control" formControlName="cdl" rows="1"></textarea>
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Début</label>
                <input type="date" class="form-control" placeholder="dd-MM-yyyy" formControlName="dl" />
              </div>
              <div class="col-lg-6 col-md-6">
                <label class="form-label">Fin</label>
                <input type="date" class="form-control" placeholder="dd-MM-yyyy" formControlName="fl" />
              </div>
              <!-- Bouton de sélection de plage conditionné par la case à cocher -->
              <div class="col-12" *ngIf="projectForm.get('livraisonChecked').value">
                <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('livraison')">
                  <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Boutons -->
      <div class="col-12 text-end">
        <button type="button" class="btn btn-outline-secondary me-2" (click)="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-success">Modifier</button>
      </div>

    </div>
  </form>
</div>

<!-- Modal pour la sélection de la plage de dates -->
<ng-template #dateRangeModal>
  <div class="modal-header">
    <h5 class="modal-title">Sélectionner une plage de dates</h5>
    <button type="button" class="btn-close" (click)="dateRangeModalRef?.hide()"></button>
  </div>
  <div class="modal-body text-center">
    <div class="mb-3">
      <input type="text" 
             class="form-control text-center" 
             bsDaterangepicker 
             [(bsValue)]="bsValue" 
             [bsConfig]="bsConfig"
             placeholder="Sélectionnez une plage de dates">
    </div>
  </div>
  <div class="modal-footer justify-content-center">
    <button type="button" class="btn btn-secondary" (click)="clearDateSelection()">Effacer</button>
    <button type="button" class="btn btn-primary" (click)="applyDateSelection()">Appliquer</button>
  </div>
</ng-template>