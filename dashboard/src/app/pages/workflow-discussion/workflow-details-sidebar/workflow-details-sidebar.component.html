<div class="details-sidebar" *ngIf="discussion">
  <div class="sidebar-header">
    <h4>Détails du workflow</h4>
    <small class="text-muted">Phase actuelle: {{ discussion.currentPhase | uppercase }}</small>
  </div>

  <!-- Navigation Tabs -->
  <nav class="sidebar-tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'cdc'" 
      (click)="setActiveTab('cdc')"
      *ngIf="discussion?.cdc">
      Cahier des charges
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'devis'" 
      (click)="setActiveTab('devis')"
      *ngIf="discussion?.devis">
      Devis
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'orders'" 
      (click)="setActiveTab('orders')"
      *ngIf="discussion?.orders?.length > 0">
      Commandes
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'projects'" 
      (click)="setActiveTab('projects')"
      *ngIf="discussion?.projects?.length > 0">
      Projets
    </button>
  </nav>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Cahier des charges -->
<div class="sidebar-section" *ngIf="discussion?.cdc && activeTab === 'cdc'">
  <div class="section-header" (click)="toggleSection('cdc')">
    <h5>Cahier des charges</h5>
    <span class="toggle-icon">{{ sections.cdc ? '−' : '+' }}</span>
  </div>
  <div class="section-content" *ngIf="sections.cdc">
    <p><strong>Titre:</strong> {{ discussion.cdc.titre }}</p>
    <p><strong>État:</strong> 
      <span class="badge" [ngClass]="{
        'badge-soft-danger': discussion.cdc.etat === 'Refusé',
        'badge-soft-warning': discussion.cdc.etat === 'En attente',
        'badge-soft-info': discussion.cdc.etat === 'À compléter',
        'badge-soft-success': discussion.cdc.etat === 'Accepté'
      }">
        {{ discussion.cdc.etat }}
      </span>
    </p>
    <p><strong>Date de création:</strong> {{ discussion.cdc.createdAt | date }}</p>
    <p *ngIf="discussion.cdc.user"><strong>Créé par:</strong> {{ discussion.cdc.user.username }}</p>

    <div class="btn-group" role="group">
      <button class="btn btn-sm btn-warning" (click)="archiveCdc(discussion.cdc.id)">
        Archiver
      </button>
      <button class="btn btn-sm btn-danger" (click)="deleteCdc(discussion.cdc.id)">
        Supprimer
      </button>
    </div>
  </div>
</div>

<!-- Devis -->
<div class="sidebar-section" *ngIf="discussion?.devis && activeTab === 'devis'">
  <div class="section-header" (click)="toggleSection('devis')">
    <h5>Devis</h5>
    <span class="toggle-icon">{{ sections.devis ? '−' : '+' }}</span>
  </div>
  <div class="section-content" *ngIf="sections.devis">
    <p><strong>Numéro:</strong> {{ discussion.devis.numdevis }}</p>
    <p><strong>Projet:</strong> {{ discussion.devis.projet }}</p>
    <p><strong>État:</strong> 
      <span class="badge" [ngClass]="{
        'badge-soft-danger': discussion.devis.etat === 'Refusé',
        'badge-soft-warning': discussion.devis.etat === 'En attente',
        'badge-soft-info': discussion.devis.etat === 'Négociation',
        'badge-soft-success': discussion.devis.etat === 'Accepté'
      }">
        {{ discussion.devis.etat }}
      </span>
    </p>
    <p><strong>Date de création:</strong> {{ discussion.devis.createdAt | date }}</p>

    <div class="btn-group" role="group">
      <button class="btn btn-sm btn-warning" (click)="archiveDevis(discussion.devis.id)">
        Archiver
      </button>
      <button class="btn btn-sm btn-danger" (click)="deleteDevis(discussion.devis.id)">
        Supprimer
      </button>
    </div>
  </div>
</div>


    <!-- Commandes avec boutons d'actions -->
    <div *ngIf="discussion?.orders?.length > 0 && activeTab === 'orders'">
      <div class="sidebar-section">
        <div class="section-header" (click)="toggleSection('orders')">
          <h5>Commandes ({{ discussion.orders.length }})</h5>
          <span class="toggle-icon">{{ sections.orders ? '−' : '+' }}</span>
        </div>
        <div class="section-content" *ngIf="sections.orders">
          <div *ngFor="let order of discussion.orders" class="order-item">
            <div class="order-header" (click)="toggleSection('projects-' + order.idOrder)">
              <h6>Commande: {{ order.orderName }}</h6>
              <span class="toggle-icon">{{ sections['projects-' + order.idOrder] ? '−' : '+' }}</span>
            </div>

            <div class="order-details" *ngIf="sections['projects-' + order.idOrder]">
              <p><strong>Date:</strong> {{ order.createdAt | date }}</p>
              <p><strong>Client:</strong> {{ order.user?.username || 'Non spécifié' }}</p>
              <p><strong>Statut:</strong> 
                <span class="badge" [ngClass]="getOrderStatusClass(order)">
                  {{ order.annuler ? 'Annulé' : 'Actif' }}
                </span>
              </p>

              <div class="btn-group mb-2" role="group">
                <button class="btn btn-sm btn-primary" (click)="addProjectToOrder(order)">
                  Ajouter Projet
                </button>
                <button class="btn btn-sm btn-warning" (click)="archiveOrder(order.idOrder)">
                  Archiver
                </button>
                <button class="btn btn-sm btn-danger" (click)="deleteOrder(order.idOrder)">
                  Supprimer
                </button>
              </div>

              <!-- Projets reliés à la commande -->
              <div *ngIf="order.projects && order.projects.length > 0">
                <h6>Projets associés ({{ order.projects.length }})</h6>
                <div *ngFor="let project of order.projects" class="project-item">
                  <div class="project-header">
                    <p><strong>Référence client:</strong> {{ project.refClient }}</p>
                    <p><strong>Référence interne:</strong> {{ project.refProdelec }}</p>
                    <p><strong>Statut:</strong> 
                      <span class="badge" [ngClass]="getProjectStatusClass(project)">
                        {{ getProjectStatus(project) }}
                      </span>
                    </p>
                  </div>
                  <div class="project-details">
                    <p><strong>Quantité:</strong> {{ project.qte }}</p>
                    <p><strong>Date limite:</strong> {{ project.dlp | date }}</p>
                    <p><strong>Progression:</strong> {{ project.progress }}%</p>
                    <p><strong>Durée estimée:</strong> {{ project.duree }} jours</p>
                  </div>
                  <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-info me-2" (click)="duplicateProject(project)">
                      Dupliquer
                    </button>
                    <button *ngIf="getProjectStatus(project) == 'Terminé'" class="btn btn-sm btn-warning me-2" (click)="archiveProject(project.idproject)">
                      Archiver
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="deleteProject(project.idproject)">
                      Supprimer
                    </button>
                    <button class="btn btn-sm btn-secondary" (click)="viewProjectDetails(project)">
                      Détails
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Projets avec boutons -->
    <div class="sidebar-section" *ngIf="discussion?.projects?.length > 0 && activeTab === 'projects'">
      <div class="section-header" (click)="toggleSection('projects')">
        <h5>Projets ({{ discussion.projects.length }})</h5>
        <span class="toggle-icon">{{ sections.projects ? '−' : '+' }}</span>
      </div>
      <div class="section-content" *ngIf="sections.projects">
        <div *ngFor="let project of discussion.projects" class="project-item mb-3">
          <h6> <strong>Commande:</strong>{{ project.order.orderName }} </h6>
          <h6>{{ project.refClient }} - {{ project.refProdelec }}</h6>
          <p><strong>Quantité:</strong> {{ project.qte }}</p>
          <p><strong>Progression:</strong> {{ project.progress }}%</p>
          <p><strong>Durée estimée:</strong> {{ project.duree }} jours</p>
          <p><strong>Date limite:</strong> {{ project.dlp | date }}</p>
          <p><strong>Statut:</strong>
            <span class="badge" [ngClass]="getProjectStatusClass(project)">
              {{ getProjectStatus(project) }}
            </span>
          </p>

          <div class="btn-group" role="group">
            <button class="btn btn-sm btn-info me-2" (click)="duplicateProject(project)">
              Dupliquer
            </button>
            <button *ngIf="getProjectStatus(project) == 'Terminé'" class="btn btn-sm btn-warning me-2" (click)="archiveProject(project.idproject)">
              Archiver
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteProject(project.idproject)">
              Supprimer
            </button>
            <button class="btn btn-sm btn-secondary" (click)="viewProjectDetails(project)">
              Détails
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
