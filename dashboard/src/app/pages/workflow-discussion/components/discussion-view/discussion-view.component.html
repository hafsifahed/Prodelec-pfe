<div class="discussion-container" *ngIf="!isLoading; else loading" style="display:flex; flex-direction: column; height: 100%;">

    <!-- Nouveaux boutons pour la phase 'cdc' -->
  <div class="discussion-actions" *ngIf="discussion?.cdc" style="padding: 10px; display: flex; gap: 10px;">
   <ng-container *ngIf="discussion?.currentPhase === 'cdc'"> 
    <button *ngIf="!currentUser.role?.name.startsWith('CLIENT') && discussion.cdc.etat == EtatCdc.EnAttente" type="button" class="btn btn-success" (click)="onAccept()" title="Accepter">
      <i class="mdi mdi-check-outline"></i> Accepter
    </button>
    <button *ngIf="!currentUser.role?.name.startsWith('CLIENT') && discussion.cdc.etat == EtatCdc.EnAttente" type="button" class="btn btn-danger" (click)="onRefuse()" title="Refuser">
      <i class="mdi mdi-close-outline"></i> Refuser
    </button>
    <button *ngIf="!currentUser.role?.name.startsWith('CLIENT') && discussion.cdc.etat == EtatCdc.EnAttente" type="button" class="btn btn-warning" (click)="onMarkIncomplete()" title="Marquer comme À compléter">
      <i class="mdi mdi-alert-circle-outline"></i> À compléter
    </button>
   </ng-container>

    <!-- Nouveaux boutons pour la phase 'devis' -->
  <ng-container *ngIf="discussion.currentPhase === 'devis'">
    <button *ngIf="discussion.devis.etat !== EtatDevis.Accepte && discussion.devis.etat !== EtatDevis.Refuse"
            type="button" class="btn btn-success btn-sm"
            (click)="accepterDevis(discussion.devis.id)"
            title="Accepter">
      <i class="mdi mdi-check-outline"></i> Accepter
    </button>
    <button *ngIf="discussion.devis.etat !== EtatDevis.Accepte && discussion.devis.etat !== EtatDevis.Refuse"
            type="button" class="btn btn-danger btn-sm"
            (click)="openCommentModal(discussion.devis.id)"
            title="Refuser">
      <i class="mdi mdi-close-outline"></i> Refuser
    </button>
    <button  *ngIf="discussion.devis.etat === EtatDevis.EnAttente && currentUser.role?.name.startsWith('CLIENT')"
            type="button" class="btn btn-outline-warning btn-sm"
            (click)="openNegociationModal(discussion.devis.id)"
            title="Démarrer négociation">
      <i class="mdi mdi-handshake-outline"></i> Négocier
    </button>
    <button *ngIf="discussion.devis.etat === EtatDevis.Accepte || discussion.devis.etat === EtatDevis.Refuse"
            type="button" class="btn btn-outline-secondary btn-sm"
            (click)="openDeleteModal(discussion.devis.id)"
            title="Archiver">
      <i class="mdi mdi-archive"></i> Archiver
    </button>
     <button *ngIf="currentUser.role?.name.startsWith('CLIENT')"class="btn btn-outline-primary btn-sm" (click)="openDetailsModal(discussion.devis.id)">
                <i class="bx bxs-detail me-1"></i> Détails
      </button>
           <button *ngIf="!currentUser.role?.name.startsWith('CLIENT')" class="btn btn-outline-primary btn-sm" (click)="openDetailsWorkerModal(discussion.devis.id)">
                <i class="bx bxs-detail me-1"></i> Détails
      </button>
  </ng-container>

      <!-- Nouveaux boutons pour la phase 'order' -->
  <ng-container *ngIf="discussion.currentPhase === 'order'">
        <button class="btn btn-success" routerLink="/addorder">+ Ajouter Commande</button>

  </ng-container>

  <!-- Nouveaux boutons pour la phase 'order' -->
  <ng-container *ngIf="discussion.currentPhase === 'project'">
  <!--<button class="btn btn-success" (click)="openAddProjectModal(null)">+ Ajouter Projet</button>-->

  </ng-container>


  </div>

  <div #messagesContainer class="messages-container" style="flex-grow: 1; overflow-y: auto; padding: 10px; background:#101025;">
    <ng-container *ngFor="let message of messages$ | async; trackBy: trackByMessageId">
      <div class="message"
           [class.mine]="message.author?.id === currentUser?.id"
           [class.optimistic]="message.id < 0"
           style="margin-bottom: 12px; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.05);">
        <div class="message-header" *ngIf="message.author?.id !== currentUser?.id" style="display: flex; align-items: center; gap: 8px;">
          <img [src]="getImageUrl(message.author)" alt="User avatar" class="avatar" width="30" height="30" style="border-radius: 50%;">
          <span class="author-name" style="font-weight: 600; color: #bbb;">
            {{ message.author?.username }}
          </span>
        </div>
        <div class="message-content" style="margin-top: 4px; color: #ddd;">{{ message.content }}</div>

        <div class="message-footer" style="font-size: 0.8rem; color: #888; margin-top: 4px;">
          <span class="message-date">
            {{ message.createdAt | date:'dd/MM/yyyy HH:mm' }}
            <span *ngIf="message.author?.id === currentUser?.id" class="you-badge" style="color: #4caf50;">(You)</span>
          </span>
          <span *ngIf="message.id < 0" class="sending-status" style="float: right;">
            <i class="fas fa-circle-notch fa-spin"></i>
          </span>
        </div>
      </div>
    </ng-container>

    <div *ngIf="typingUsers.size" class="typing-indicator" style="color: #999; font-style: italic; padding-top: 5px;">
      <span *ngFor="let userId of typingUsers; let last = last">
        {{ getParticipantName(userId) }}{{ !last ? ', ' : '' }}
      </span>
      {{ typingUsers.size > 1 ? 'are' : 'is' }} typing...
    </div>
  </div>

  <app-message-input style="padding: 10px; border-top: 1px solid #222;"
                     (messageSent)="sendMessage($event)"
                     (typing)="handleTyping()"
                     [disabled]="!isConnected || isSending">
  </app-message-input>
</div>

<ng-template #loading>
  <div class="loading-container" style="display:flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
    <div class="spinner-border text-primary" role="status"></div>
    <p style="color: #666;">Loading discussion...</p>
  </div>
</ng-template>

<div *ngIf="error" class="alert alert-danger mt-3">
  {{ error }}
  <button class="btn btn-sm btn-light ms-2" (click)="loadDiscussion()">Retry</button>
</div>
