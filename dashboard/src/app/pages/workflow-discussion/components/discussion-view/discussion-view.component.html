<div class="discussion-container" *ngIf="!isLoading; else loading">
  
  <div class="connection-status" [class.connected]="isConnected" [class.disconnected]="!isConnected">
    {{ isConnected ? 'Connected' : 'Disconnected' }}
  </div>
  
  <div class="discussion-header">
    <h2><i class="fas fa-comments"></i> {{ discussion?.cdc?.titre || 'Untitled Discussion' }}</h2>
  </div>

  <div #messagesContainer class="messages-container">
    <ng-container *ngFor="let message of messages$ | async; trackBy: trackByMessageId">
      <div class="message"
           [class.mine]="message.author?.id === currentUser?.id"
           [class.optimistic]="message.id < 0">

        <div class="message-header" *ngIf="message.author?.id !== currentUser?.id">
          <img [src]="getImageUrl(message.author)"
               alt="User avatar"
               class="avatar"
               onerror="this.src='assets/images/companies/img-6.png'">
          <span class="author-name">
            {{ message.author?.username }}
          </span>
        </div>

        <div class="message-content">{{ message.content }}</div>

        <div class="message-footer">
          <span class="message-date">
            {{ message.createdAt | date:'dd/MM/yyyy HH:mm' }}
            <span *ngIf="message.author?.id === currentUser?.id" class="you-badge">(You)</span>
          </span>
          <span *ngIf="message.id < 0" class="sending-status">
            <i class="fas fa-circle-notch fa-spin"></i>
          </span>
        </div>
      </div>
    </ng-container>

    <div *ngIf="typingUsers.size" class="typing-indicator">
      <span *ngFor="let userId of typingUsers; let last = last">
        {{ getParticipantName(userId) }}{{ !last ? ', ' : '' }}
      </span>
      {{ typingUsers.size > 1 ? 'are' : 'is' }} typing...
    </div>
  </div>

  <app-message-input
    (messageSent)="handleMessageSent($event)"
    (typing)="handleTyping()"
    [disabled]="!isConnected || isSending">
  </app-message-input>
</div>

<ng-template #loading>
  <div class="loading-container">
    <div class="spinner-border text-primary" role="status"></div>
    <p>Loading discussion...</p>
  </div>
</ng-template>

<div *ngIf="error" class="alert alert-danger mt-3">
  {{ error }}
  <button class="btn btn-sm btn-light ms-2" (click)="loadDiscussion()">Retry</button>
</div>