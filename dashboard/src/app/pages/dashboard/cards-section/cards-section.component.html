<!-- cards-section.component.html -->

<div class="dashboard-cards">
  <!-- En-tête avec filtres de période -->
  <div class="dashboard-header">
    <div class="header-title">
      <h2>Tableau de Bord</h2>
      <p class="text-muted">Vue d'ensemble de votre activité</p>
    </div>
    
    <div class="period-filters">
      <!-- Filtres de période -->
      <div class="btn-group period-buttons" role="group">
        <button 
          *ngFor="let period of periods"
          type="button" 
          class="btn period-btn"
          [class.active]="selectedPeriod === period.value"
          (click)="onPeriodChange(period.value)">
          <i [class]="period.icon"></i>
          {{ period.label }}
        </button>
      </div>

      <!-- Sélecteur d'année (visible seulement pour la période "year") -->
      <div class="year-selector" *ngIf="selectedPeriod === 'year' && availableYears.length > 0">
        <label for="yearSelect" class="form-label">Année:</label>
        <select 
          id="yearSelect" 
          class="form-select" 
          [value]="selectedYear"
          (change)="onYearChange($any($event.target).value)">
          <option *ngFor="let year of availableYears" [value]="year">
            {{ year }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Indicateurs de performance -->
  <div class="performance-indicators" *ngIf="hasComparativeData && comparativeStats">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="indicator-card">
          <div class="indicator-icon">
            <i class="bx bx-trending-up"></i>
          </div>
          <div class="indicator-content">
            <div class="indicator-value" [class]="'text-' + getTrendColor(comparativeStats.comparison?.trend || 'stable')">
              {{ comparativeStats.comparison?.change || 0 }}%
            </div>
            <div class="indicator-label">
              <i [class]="getTrendIcon(comparativeStats.comparison?.trend || 'stable')"></i>
              Évolution commandes
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-9">
        <div class="period-info">
          <div class="info-item">
            <span class="label">Période:</span>
            <span class="value">{{ getPeriodLabel(selectedPeriod) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Données mises à jour:</span>
            <span class="value">{{ now | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="info-item" *ngIf="selectedPeriod === 'year' && selectedYear">
            <span class="label">Année sélectionnée:</span>
            <span class="value badge bg-primary">{{ selectedYear }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-section">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-2 text-muted">Chargement des statistiques...</p>
  </div>

  <!-- Cartes principales -->
  <div *ngIf="!isLoading" class="row g-4 mt-3">
    <!-- Clients -->
    <div class="col-md-6 col-xl-3" *ngIf="stats.sessions">
      <div class="neu-card client-neu">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx bx-user-circle"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ stats.sessions.totalClients }}</div>
            <div class="neu-label">Clients</div>
            <div class="neu-sub">
              <span class="online-dot"></span>
              {{ stats.sessions.connectedClients }} en ligne
            </div>
          </div>
        </div>
        <div class="neu-trend">
          <i class="bx bx-trending-up"></i>
        </div>
      </div>
    </div>

    <!-- Employés -->
    <div class="col-md-6 col-xl-3" *ngIf="stats.sessions">
      <div class="neu-card employee-neu">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx bx-briefcase"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ stats.sessions.totalEmployees }}</div>
            <div class="neu-label">Employés</div>
            <div class="neu-sub">
              <span class="online-dot"></span>
              {{ stats.sessions.connectedEmployees }} en ligne
            </div>
          </div>
        </div>
        <div class="neu-trend">
          <i class="bx bx-trending-up"></i>
        </div>
      </div>
    </div>

    <!-- Taux de réussite -->
    <div class="col-md-6 col-xl-3">
      <div class="neu-card success-neu">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx bx-check-circle"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ getOrderProgress() | number:'1.0-0' }}%</div>
            <div class="neu-label">Taux de réussite</div>
            <div class="neu-sub">
              {{ stats.totalOrders - stats.cancelledOrders }}/{{ stats.totalOrders }} commandes
            </div>
          </div>
        </div>
        <div class="neu-trend">
          <i [class]="getTrendIcon(comparativeStats?.comparison?.trend || 'stable')"></i>
        </div>
      </div>
    </div>

    <!-- Réclamations -->
    <div class="col-md-6 col-xl-3">
      <div class="neu-card reclamation-neu" [class.exceeded]="stats.reclamationRatio > setting?.reclamationTarget">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx" [class.bx-error]="stats.reclamationRatio > setting?.reclamationTarget" 
                         [class.bx-check-shield]="stats.reclamationRatio <= setting?.reclamationTarget"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ stats.reclamationRatio | number: '1.0-1' }}%</div>
            <div class="neu-label">Réclamations</div>
            <div class="neu-sub">
              {{ stats.completedProjects }} projets terminés
            </div>
          </div>
        </div>
        <div class="neu-indicator" [class.exceeded]="stats.reclamationRatio > setting?.reclamationTarget">
          <div class="indicator-dot"></div>
        </div>
      </div>
    </div>

    <!-- Satisfaction -->
    <div class="col-md-6 col-xl-3">
      <div class="neu-card satisfaction-neu">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx bx-heart"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ stats.averageAvis | number:'1.1-1' }}</div>
            <div class="neu-label">Satisfaction</div>
            <div class="neu-rating">
              <div class="stars">
                <i class="bx bxs-star" *ngFor="let star of [1,2,3,4,5]"
                   [class.active]="star <= (stats.averageAvis / 20)"></i>
              </div>
              <span class="rating-count">{{ stats.totalAvis }} avis</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nouvelles commandes -->
    <div class="col-md-6 col-xl-3">
      <div class="neu-card new-orders-neu">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx bx-cart-alt"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ stats.newOrders || 0 }}</div>
            <div class="neu-label">Nouvelles commandes</div>
            <div class="neu-sub">
              Cette période
            </div>
          </div>
        </div>
        <div class="neu-trend" *ngIf="hasComparativeData && comparativeStats?.comparison?.trend === 'up'">
          <i class="bx bx-up-arrow-alt text-success"></i>
        </div>
      </div>
    </div>

    <!-- Nouveaux projets -->
    <div class="col-md-6 col-xl-3">
      <div class="neu-card new-projects-neu">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx bx-folder-plus"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ stats.newProjects || 0 }}</div>
            <div class="neu-label">Nouveaux projets</div>
            <div class="neu-sub">
              Cette période
            </div>
          </div>
        </div>
        <div class="neu-trend" *ngIf="hasComparativeData && comparativeStats?.comparison?.trend === 'up'">
          <i class="bx bx-up-arrow-alt text-success"></i>
        </div>
      </div>
    </div>

    <!-- Projets terminés -->
    <div class="col-md-6 col-xl-3">
      <div class="neu-card completed-projects-neu">
        <div class="neu-content">
          <div class="neu-icon">
            <i class="bx bx-check-double"></i>
          </div>
          <div class="neu-data">
            <div class="neu-value">{{ stats.completedProjects }}</div>
            <div class="neu-label">Projets terminés</div>
            <div class="neu-sub">
              {{ getDelayedPercentage() | number:'1.1-1' }}% de retard
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Commandes -->
    <div class="col-12 col-xl-6">
      <div class="neu-combined orders-neu">
        <div class="combined-header">
          <div class="header-title">
            <i class="bx bxs-cart"></i>
            <h3>Performance des Commandes</h3>
          </div>
          <div class="header-stats">
            <div class="stat-pill" [class.positive]="getOrderProgress() > 75">
              {{ getOrderProgress() | number:'1.0-0' }}% de réussite
            </div>
          </div>
        </div>

        <div class="combined-body">
          <div class="metric-row">
            <div class="metric-col">
              <div class="metric-card">
                <div class="metric-header">
                  <i class="bx bx-cart-alt"></i>
                  <span class="metric-title">Total</span>
                </div>
                <div class="metric-value">{{ stats.totalOrders }}</div>
                <div class="metric-progress">
                  <div class="neu-progress">
                    <div class="progress-fill" [style.width.%]="100"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="metric-col">
              <div class="metric-card success">
                <div class="metric-header">
                  <i class="bx bx-check-circle"></i>
                  <span class="metric-title">Réussies</span>
                </div>
                <div class="metric-value">{{ stats.totalOrders - stats.cancelledOrders }}</div>
                <div class="metric-progress">
                  <div class="neu-progress">
                    <div class="progress-fill success" [style.width.%]="getOrderProgress()"></div>
                  </div>
                  <span class="progress-text">{{ getOrderProgress() | number:'1.0-0' }}%</span>
                </div>
              </div>
            </div>

            <div class="metric-col">
              <div class="metric-card danger">
                <div class="metric-header">
                  <i class="bx bx-x-circle"></i>
                  <span class="metric-title">Annulées</span>
                </div>
                <div class="metric-value">{{ stats.cancelledOrders }}</div>
                <div class="metric-progress">
                  <div class="neu-progress">
                    <div class="progress-fill danger" [style.width.%]="getCancellationRate()"></div>
                  </div>
                  <span class="progress-text">{{ getCancellationRate() | number:'1.1-1' }}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Projets -->
    <div class="col-12 col-xl-6">
      <div class="neu-combined projects-neu">
        <div class="combined-header">
          <div class="header-title">
            <i class="bx bxs-briefcase"></i>
            <h3>État des Projets</h3>
          </div>
          <div class="header-stats">
            <div class="stat-pill" [class.warning]="getDelayedPercentage() > 10" 
                                 [class.success]="getDelayedPercentage() <= 10">
              {{ getDelayedPercentage() <= 10 ? 'Dans les temps' : 'Attention retard' }}
            </div>
          </div>
        </div>

        <div class="combined-body">
          <div class="project-stats">
            <div class="project-metric">
              <div class="metric-visual">
                <div class="neu-circle active">
                  <span class="circle-value">{{ stats.totalProjects }}</span>
                </div>
              </div>
              <div class="metric-info">
                <div class="metric-label">En Cours</div>
                <div class="metric-desc">Projets actifs</div>
              </div>
            </div>

            <div class="project-metric">
              <div class="metric-visual">
                <div class="neu-circle completed">
                  <span class="circle-value">{{ stats.completedProjects }}</span>
                </div>
              </div>
              <div class="metric-info">
                <div class="metric-label">Terminés</div>
                <div class="metric-desc">Livraisons réussies</div>
              </div>
            </div>

            <div class="project-metric">
              <div class="metric-visual">
                <div class="neu-circle delayed">
                  <span class="circle-value">{{ stats.lateProjects }}</span>
                </div>
              </div>
              <div class="metric-info">
                <div class="metric-label">Retards</div>
                <div class="metric-desc">{{ getDelayedPercentage() | number:'1.1-1' }}% des projets</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>