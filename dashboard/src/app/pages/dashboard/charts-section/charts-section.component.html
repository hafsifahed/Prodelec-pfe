<div class="charts-section">
  <!-- Header avec titre et bouton d'export -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Tableau de Bord Statistiques</h2>
      <p class="text-muted mb-0">Vue d'ensemble de vos performances et métriques</p>
    </div>
  <!--  <button class="btn btn-success export-btn" 
            (click)="exportChartsToPdf()" 
            [disabled]="isExporting || isLoading">
      <i class="bx bx-download" *ngIf="!isExporting"></i>
      <i class="bx bx-loader bx-spin" *ngIf="isExporting"></i>
      {{ isExporting ? 'Génération PDF...' : 'Exporter PDF' }}
    </button>-->
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <div class="filter-group">
      <div class="filter-item">
        <label for="yearSelect" class="form-label">Année:</label>
        <select 
          id="yearSelect" 
          class="form-select" 
          [value]="selectedYear"
          (change)="onYearChange($event)">
          <option [value]="null">Toutes les années</option>
          <option *ngFor="let year of years" [value]="year">
            {{ year }}
          </option>
        </select>
      </div>

      <div class="filter-item">
        <label for="partnerSelect" class="form-label">Partenaire:</label>
        <select 
          id="partnerSelect" 
          class="form-select" 
          [value]="selectedPartner"
          (change)="onPartnerChange($event)">
          <option [value]="null">Tous les partenaires</option>
          <option *ngFor="let partner of partners" [value]="partner.id">
            {{ partner.name }}
          </option>
        </select>
      </div>

      <div class="filter-item">
        <label for="userSelect" class="form-label">Utilisateur:</label>
        <select 
          id="userSelect" 
          class="form-select" 
          [value]="selectedUser"
          (change)="onUserChange($event)"
          [disabled]="filteredUsers.length === 0">
          <option [value]="null">Tous les utilisateurs</option>
          <option *ngFor="let user of filteredUsers" [value]="user.id">
            {{ user.username || user.email }}
          </option>
        </select>
      </div>

      <div class="filter-item">
        <br>
        <button class="btn btn-outline-secondary" (click)="resetFilters()">
          <i class="bx bx-reset"></i> Réinitialiser
        </button>
      </div>
    </div>

    <div class="export-section" *ngIf="isWorker()">
      <button class="btn btn-success export-btn" 
              (click)="exportChartsToPdf()" 
              [disabled]="isExporting || isLoading">
        <i class="bx bx-download" *ngIf="!isExporting"></i>
        <i class="bx bx-loader bx-spin" *ngIf="isExporting"></i>
        {{ isExporting ? 'Génération PDF...' : 'Exporter PDF' }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-section text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-2 text-muted">Chargement des graphiques...</p>
  </div>

  <!-- Graphiques -->
  <div *ngIf="!isLoading" class="charts-container">
    <div class="row g-4">
      
      <!-- Réclamations -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Réclamations</h3>
            <div class="chart-badge" [class.no-data]="!hasReclamationData">
              {{ hasReclamationData ? 'Données disponibles' : 'Aucune donnée' }}
            </div>
          </div>
          <div class="chart-body">
            <div *ngIf="hasReclamationData && chartOptionsReclamations" class="chart-wrapper">
              <apx-chart
                [series]="chartOptionsReclamations.series"
                [chart]="chartOptionsReclamations.chart"
                [labels]="chartOptionsReclamations.labels"
                [responsive]="chartOptionsReclamations.responsive"
                [legend]="chartOptionsReclamations.legend"
                [colors]="chartOptionsReclamations.colors"
                [dataLabels]="chartOptionsReclamations.dataLabels"
                [plotOptions]="chartOptionsReclamations.plotOptions">
              </apx-chart>
            </div>
            <div *ngIf="!hasReclamationData" class="no-data-placeholder">
              <i class="bx bx-pie-chart-alt"></i>
              <p>Aucune donnée de réclamation disponible</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Cahiers des Charges -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Cahiers des Charges</h3>
            <div class="chart-badge" [class.no-data]="!hasCdcData">
              {{ hasCdcData ? 'Données disponibles' : 'Aucune donnée' }}
            </div>
          </div>
          <div class="chart-body">
            <div *ngIf="hasCdcData && chartOptionsCahiersDesCharges" class="chart-wrapper">
              <apx-chart
                [series]="chartOptionsCahiersDesCharges.series"
                [chart]="chartOptionsCahiersDesCharges.chart"
                [labels]="chartOptionsCahiersDesCharges.labels"
                [responsive]="chartOptionsCahiersDesCharges.responsive"
                [legend]="chartOptionsCahiersDesCharges.legend"
                [colors]="chartOptionsCahiersDesCharges.colors"
                [dataLabels]="chartOptionsCahiersDesCharges.dataLabels"
                [plotOptions]="chartOptionsCahiersDesCharges.plotOptions">
              </apx-chart>
            </div>
            <div *ngIf="!hasCdcData" class="no-data-placeholder">
              <i class="bx bx-file"></i>
              <p>Aucun cahier des charges disponible</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Devis -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Devis</h3>
            <div class="chart-badge" [class.no-data]="!hasDevisData">
              {{ hasDevisData ? 'Données disponibles' : 'Aucune donnée' }}
            </div>
          </div>
          <div class="chart-body">
            <div *ngIf="hasDevisData && chartOptionsDevis" class="chart-wrapper">
              <apx-chart
                [series]="chartOptionsDevis.series"
                [chart]="chartOptionsDevis.chart"
                [labels]="chartOptionsDevis.labels"
                [responsive]="chartOptionsDevis.responsive"
                [legend]="chartOptionsDevis.legend"
                [colors]="chartOptionsDevis.colors"
                [dataLabels]="chartOptionsDevis.dataLabels"
                [plotOptions]="chartOptionsDevis.plotOptions">
              </apx-chart>
            </div>
            <div *ngIf="!hasDevisData" class="no-data-placeholder">
              <i class="bx bx-receipt"></i>
              <p>Aucun devis disponible</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Projets -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Projets</h3>
            <div class="chart-badge" [class.no-data]="!hasProjectData">
              {{ hasProjectData ? 'Données disponibles' : 'Aucune donnée' }}
            </div>
          </div>
          <div class="chart-body">
            <div *ngIf="hasProjectData && chartOptionsProjects" class="chart-wrapper">
              <apx-chart
                [series]="chartOptionsProjects.series"
                [chart]="chartOptionsProjects.chart"
                [labels]="chartOptionsProjects.labels"
                [responsive]="chartOptionsProjects.responsive"
                [legend]="chartOptionsProjects.legend"
                [colors]="chartOptionsProjects.colors"
                [dataLabels]="chartOptionsProjects.dataLabels"
                [plotOptions]="chartOptionsProjects.plotOptions">
              </apx-chart>
            </div>
            <div *ngIf="!hasProjectData" class="no-data-placeholder">
              <i class="bx bx-briefcase"></i>
              <p>Aucun projet disponible</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Avis Clients -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Avis Clients</h3>
            <div class="chart-badge" [class.no-data]="!hasAvisData">
              {{ hasAvisData ? 'Données disponibles' : 'Aucune donnée' }}
            </div>
          </div>
          <div class="chart-body">
            <div *ngIf="hasAvisData && chartOptionsAvis" class="chart-wrapper">
              <apx-chart
                [series]="chartOptionsAvis.series"
                [chart]="chartOptionsAvis.chart"
                [labels]="chartOptionsAvis.labels"
                [responsive]="chartOptionsAvis.responsive"
                [legend]="chartOptionsAvis.legend"
                [colors]="chartOptionsAvis.colors"
                [dataLabels]="chartOptionsAvis.dataLabels"
                [plotOptions]="chartOptionsAvis.plotOptions">
              </apx-chart>
              <div class="avis-summary">
                <div class="average-rating">
                  <strong>Moyenne: {{ (averageAvis / 20).toFixed(1) }}/5</strong>
                </div>
                <div class="total-avis">
                  Total: {{ totalAvis }} avis
                </div>
              </div>
            </div>
            <div *ngIf="!hasAvisData" class="no-data-placeholder">
              <i class="bx bx-star"></i>
              <p>Aucun avis disponible</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>