<div class="container-fluid">
  <app-page-title [title]="'Devis'" [breadcrumbItems]="breadcrumbItems"></app-page-title>
  
  <div class="row mb-4">
    <div class="d-flex justify-content-between align-items-end w-100">
      <div class="d-flex flex-column col-sm-12 col-md-2">
        <label for="yearFilter" class="form-label">Filtrer par année</label>
        <select id="yearFilter" class="form-select" [(ngModel)]="selectedYear" (change)="onYearChange()">
          <option *ngFor="let year of getUniqueYears()" [value]="year">{{ year }}</option>
        </select>
      </div>
      <div class="d-flex flex-column col-sm-12 col-md-4">
        <input 
          type="text" 
          id="searchFilter" 
          class="form-control" 
          [(ngModel)]="searchQuery" 
          (input)="onSearchQueryChange()" 
          placeholder="Rechercher par projet ou client"
          autocomplete="off"
        />
      </div>
      <div class="d-flex justify-content-end col-sm-12 col-md-4">
        <button class="btn btn-success" routerLink="devisArchive">
          <i class="mdi mdi-archive me-1"></i> Voir l'archive
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="getNonArchivedDevis().length === 0" class="mt-4">
    <div class="alert alert-info text-center">Aucun devis disponible.</div>
  </div>

  <div *ngIf="getNonArchivedDevis().length > 0">
    <div class="table-responsive mb-0">
      <table class="table table-centered table-hover table-nowrap">
        <thead class="table-light">
          <tr>
            <th class="align-middle">Projet</th>
            <th class="align-middle">Client</th>
            <th class="align-middle" (click)="sortDevisByDate()" style="cursor: pointer;">
              Date de création
              <i class="mdi" [ngClass]="{'mdi-arrow-up': isAscending, 'mdi-arrow-down': !isAscending}"></i>
            </th>
            <th class="align-middle">État</th>
            <th class="align-middle">Détails</th>
            <th class="align-middle text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let devis of getNonArchivedDevis() | paginate: { itemsPerPage: itemsPerPage, currentPage: p }">
            <td class="text-body fw-bold">{{ devis.projet }}</td>
            <td>{{ devis.user?.email || 'Non spécifié' }}</td>
            <td>{{ devis.dateCreation | date:'dd/MM/yyyy' }}</td>
            <td>
              <span class="badge badge-pill font-size-11"
                [ngClass]="{
                  'badge-soft-danger': devis.etat === EtatDevis.Refuse,
                  'badge-soft-warning': devis.etat === EtatDevis.EnAttente,
                  'badge-soft-info': devis.etat === EtatDevis.Negociation,
                  'badge-soft-success': devis.etat === EtatDevis.Accepte
                }">
                {{ devis.etat }}
              </span>
            </td>
            <td>
              <button class="btn btn-outline-primary btn-sm" (click)="openDetailsModal(devis.id)">
                <i class="bx bxs-detail me-1"></i> Détails
              </button>
            </td>
            <td class="text-end">
              <div class="d-flex justify-content-end">
                <ng-container *ngIf="devis.etat === EtatDevis.Negociation">
                  <button class="btn btn-success btn-sm me-2" title="Accepter" (click)="accepterDevis(devis.id)">
                    <i class="mdi mdi-check"></i>
                  </button>
                  <button class="btn btn-danger btn-sm me-2" title="Refuser" (click)="preparerRefus(devis.id)">
                    <i class="mdi mdi-close"></i>
                  </button>
                </ng-container>
                <button class="btn btn-outline-secondary btn-sm" (click)="openDeleteModal(devis.id)" title="Archiver">
                  <i class="mdi mdi-archive"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-muted">
        Affichage de {{ getNonArchivedDevis().length }} éléments
      </div>
      <div class="pagination-container">
        <pagination-controls 
          (pageChange)="p = $event" 
          previousLabel="Précédent" 
          nextLabel="Suivant"
          screenReaderPaginationLabel="Pagination"
          screenReaderPageLabel="Page"
          screenReaderCurrentLabel="Page courante">
        </pagination-controls>
      </div>
    </div>
  </div>
</div>