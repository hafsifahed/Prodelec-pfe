<div class="modal-header">
  <h5 class="modal-title">Ajouter projet</h5>
  <button type="button" class="btn-close" (click)="closeModal()"></button>
</div>
<div class="modal-body">
  <form [formGroup]="projectForm" (ngSubmit)="addproject()" novalidate>

    <div class="mb-3">
      <label class="form-label">Étapes du projet</label>
      <div class="form-check" *ngFor="let phase of ['conception', 'methode', 'production', 'controle', 'livraison']">
        <input type="checkbox" [id]="phase + 'Checked'" class="form-check-input" [formControlName]="phase + 'Checked'"/>
        <label class="form-check-label" [for]="phase + 'Checked'">{{ phase | titlecase }}</label>
      </div>
    </div>

    <!-- Boutons d'affichage des sections conditionnels -->
    <div class="mb-3 d-flex flex-wrap gap-2">
      <button *ngIf="projectForm.get('conceptionChecked')?.value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('conception')">
        {{ showSections.conception ? 'Masquer Conception' : 'Afficher Conception' }}
      </button>
      <button *ngIf="projectForm.get('methodeChecked')?.value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('methode')">
        {{ showSections.methode ? 'Masquer Méthode' : 'Afficher Méthode' }}
      </button>
      <button *ngIf="projectForm.get('productionChecked')?.value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('production')">
        {{ showSections.production ? 'Masquer Production' : 'Afficher Production' }}
      </button>
      <button *ngIf="projectForm.get('controleChecked')?.value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('controle')">
        {{ showSections.controle ? 'Masquer Contrôle finale' : 'Afficher Contrôle finale' }}
      </button>
      <button *ngIf="projectForm.get('livraisonChecked')?.value" type="button" class="btn btn-outline-primary btn-sm" (click)="toggleSection('livraison')">
        {{ showSections.livraison ? 'Masquer Livraison' : 'Afficher Livraison' }}
      </button>
    </div>

    <div class="row">
      <div class="col-lg-12 mb-3">
        <label class="form-label">Ref Client</label>
        <input type="text" formControlName="refc" class="form-control" />
      </div>
      <div class="col-lg-12 mb-3">
        <label class="form-label">Ref Prodelec</label>
        <input type="text" formControlName="refp" class="form-control" />
      </div>
      <div class="col-lg-12 mb-3">
        <label class="form-label">Quantité</label>
        <input type="number" formControlName="qte" class="form-control" />
      </div>
      <div class="col-lg-12 mb-3">
        <label class="form-label">Date de livraison prévue</label>
        <input bsDatepicker formControlName="dlp" class="form-control" placeholder="dd-MM-yyyy" />
      </div>

      <!-- Phases - Affichage conditionnel basé sur la case à cocher ET l'état d'affichage -->

      <!-- Ex. Conception -->
      <div class="col-lg-12" *ngIf="projectForm.get('conceptionChecked')?.value && showSections.conception">
        <div class="card shadow mb-3">
          <div class="card-header bg-primary text-white fw-semibold">Conception</div>
          <div class="card-body row g-3">
            <div class="col-md-3">
              <label class="form-label">Durée</label>
              <input type="number" formControlName="drc" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Pilote</label>
              <select formControlName="rc" class="form-select">
                <option value=""></option>
                <option *ngFor="let u of listr" [value]="u.username">{{ u.username }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Début</label>
              <input bsDatepicker formControlName="dc" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Fin</label>
              <input bsDatepicker formControlName="fc" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-12">
              <label class="form-label">Commentaire</label>
              <textarea formControlName="cdc" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('conception')">
                <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Méthode -->
      <div class="col-lg-12" *ngIf="projectForm.get('methodeChecked')?.value && showSections.methode">
        <div class="card shadow mb-3">
          <div class="card-header bg-primary text-white fw-semibold">Méthode</div>
          <div class="card-body row g-3">
            <div class="col-md-3">
              <label class="form-label">Durée</label>
              <input type="number" formControlName="drm" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Pilote</label>
              <select formControlName="rm" class="form-select">
                <option value=""></option>
                <option *ngFor="let u of listr" [value]="u.username">{{ u.username }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Début</label>
              <input bsDatepicker formControlName="dm" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Fin</label>
              <input bsDatepicker formControlName="fm" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-12">
              <label class="form-label">Commentaire</label>
              <textarea formControlName="cdm" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('methode')">
                <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Production -->
      <div class="col-lg-12" *ngIf="projectForm.get('productionChecked')?.value && showSections.production">
        <div class="card shadow mb-3">
          <div class="card-header bg-primary text-white fw-semibold">Production</div>
          <div class="card-body row g-3">
            <div class="col-md-3">
              <label class="form-label">Durée</label>
              <input type="number" formControlName="drp" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Pilote</label>
              <select formControlName="rp" class="form-select">
                <option value=""></option>
                <option *ngFor="let u of listr" [value]="u.username">{{ u.username }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Début</label>
              <input bsDatepicker formControlName="dp" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Fin</label>
              <input bsDatepicker formControlName="fp" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-12">
              <label class="form-label">Commentaire</label>
              <textarea formControlName="cdp" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('production')">
                <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Contrôle Finale -->
      <div class="col-lg-12" *ngIf="projectForm.get('controleChecked')?.value && showSections.controle">
        <div class="card shadow mb-3">
          <div class="card-header bg-primary text-white fw-semibold">Contrôle final</div>
          <div class="card-body row g-3">
            <div class="col-md-3">
              <label class="form-label">Durée</label>
              <input type="number" formControlName="drcf" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Pilote</label>
              <select formControlName="rcf" class="form-select">
                <option value=""></option>
                <option *ngFor="let u of listr" [value]="u.username">{{ u.username }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Début</label>
              <input bsDatepicker formControlName="dcf" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Fin</label>
              <input bsDatepicker formControlName="fcf" class="form-control" placeholder="dd-MM-yyyy" />
            </div>
            <div class="col-12">
              <label class="form-label">Commentaire</label>
              <textarea formControlName="cdcf" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('controle')">
                <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Livraison -->
      <div class="col-lg-12" *ngIf="projectForm.get('livraisonChecked')?.value && showSections.livraison">
        <div class="card shadow mb-3">
          <div class="card-header bg-primary text-white fw-semibold">Livraison</div>
          <div class="card-body row g-3">
            <div class="col-md-3">
              <label class="form-label">Durée</label>
              <input type="number" formControlName="drl" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Pilote</label>
              <select formControlName="rl" class="form-select">
                <option value=""></option>
                <option *ngFor="let u of listr" [value]="u.username">{{ u.username }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Début</label>
              <input type="date" formControlName="dl" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Fin</label>
              <input type="date" formControlName="fl" class="form-control" />
            </div>
            <div class="col-12">
              <label class="form-label">Commentaire</label>
              <textarea formControlName="cdl" rows="2" class="form-control"></textarea>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-outline-info btn-sm" (click)="openDateRangeModal('livraison')">
                <i class="mdi mdi-calendar-range me-1"></i>Sélectionner la plage de dates
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Boutons -->
      <div class="col-lg-12 text-end">
        <button type="button" class="btn btn-outline-secondary me-2" (click)="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-success">Ajouter</button>
      </div>
    </div>

  </form>
</div>

<!-- Modal pour la sélection de la plage de dates -->
<ng-template #dateRangeModal>
  <div class="modal-header">
    <h5 class="modal-title">Sélectionner une plage de dates</h5>
    <button type="button" class="btn-close" (click)="dateRangeModalRef?.hide()"></button>
  </div>
  <div class="modal-body text-center">
    <div class="mb-3">
      <input type="text" 
             class="form-control text-center" 
             bsDaterangepicker 
             [(bsValue)]="bsValue" 
             [bsConfig]="bsConfig"
             placeholder="Sélectionnez une plage de dates">
    </div>
  </div>
  <div class="modal-footer justify-content-center">
    <button type="button" class="btn btn-secondary" (click)="clearDateSelection()">Effacer</button>
    <button type="button" class="btn btn-primary" (click)="applyDateSelection()">Appliquer</button>
  </div>
</ng-template>